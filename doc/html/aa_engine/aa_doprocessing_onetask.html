<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of aa_doprocessing_onetask</title>
  <meta name="keywords" content="aa_doprocessing_onetask">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="#">aa_engine</a> &gt; aa_doprocessing_onetask.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ./aa_engine&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>aa_doprocessing_onetask
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function aa_doprocessing_onetask(aap,task,k) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="aas_getsesspath.html" class="code" title="function [sesspath]=aas_getsesspath(aap,i,j)">aas_getsesspath</a>	Automatic analysis - get session path</li><li><a href="aas_getsubjpath.html" class="code" title="function [subjpath]=aas_getsubjpath(aap,i)">aas_getsubjpath</a>	Automatic analysis - get subject path</li><li><a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>	Automatic analysis - log tool</li><li><a href="aas_shell.html" class="code" title="function [s,w]=aas_shell(cmd)">aas_shell</a>	function [s,w]=aas_shell(cmd)</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="aa_doprocessing.html" class="code" title="function [aap]=aa_doprocessing(aap)">aa_doprocessing</a>	Automatic analysis - do processing</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function writedoneflag(aap,fn)</a></li><li><a href="#_sub2" class="code">function delete_doneflag(aap,stage,inpi)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function aa_doprocessing_onetask(aap,task,k)</a>
0002 aap.tasklist.currenttask.epiprefix=aap.tasklist.stages{k}.epiprefix;
0003 aap.tasklist.currenttask.extraparameters=aap.tasklist.stages{k}.extraparameters;
0004 
0005 <span class="comment">% retrieve description from module</span>
0006 [aap,description]=feval(aap.tasklist.stages{k}.name,aap,<span class="string">'description'</span>);
0007 
0008 <span class="comment">% find out whether this module needs to be executed once per study, subject or session</span>
0009 [aap,domain]=feval(aap.tasklist.stages{k}.name,aap,<span class="string">'domain'</span>);
0010 
0011 <span class="comment">% Now execute the module, and change the 'done' flags if task='doit'</span>
0012 <span class="keyword">switch</span> (domain)
0013     <span class="keyword">case</span> <span class="string">'study'</span>
0014         doneflag=fullfile(aap.acq_details.root,[<span class="string">'done_'</span> aap.tasklist.stages{k}.name]);
0015         <span class="keyword">if</span> (length(dir(doneflag)))
0016             <span class="keyword">if</span> (strcmp(task,<span class="string">'doit'</span>))
0017                 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'- completed previously: %s'</span>,description));
0018             <span class="keyword">end</span>;
0019         <span class="keyword">else</span>
0020             <span class="keyword">switch</span> (task)
0021                 <span class="keyword">case</span> <span class="string">'checkrequirements'</span>
0022                     [aap,resp]=feval(aap.tasklist.stages{k}.name,aap,task);
0023                     <span class="keyword">if</span> (length(resp)&gt;0)
0024                         <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,[<span class="string">'\n***WARNING: '</span> resp]);
0025                     <span class="keyword">end</span>;
0026                 <span class="keyword">case</span> <span class="string">'doit'</span>
0027                     tic
0028                     <span class="comment">% before starting current stage, delete done_</span>
0029                     <span class="comment">% flag for next one</span>
0030                     <span class="keyword">if</span> (k&lt;length(aap.tasklist.stages))
0031                         <a href="#_sub2" class="code" title="subfunction delete_doneflag(aap,stage,inpi)">delete_doneflag</a>(aap,k+1,-1);
0032                     <span class="keyword">end</span>;
0033                     <span class="comment">% now run current stage</span>
0034                     <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'MODULE %s RUNNING: %s'</span>,aap.tasklist.stages{k}.name,description));
0035                     [aap,resp]=feval(aap.tasklist.stages{k}.name,aap,task);
0036                     <a href="#_sub1" class="code" title="subfunction writedoneflag(aap,fn)">writedoneflag</a>(aap,doneflag);
0037                     <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'MODULE %s COMPLETED'</span>,aap.tasklist.stages{k}.name));
0038             <span class="keyword">end</span>;
0039 
0040         <span class="keyword">end</span>;
0041     <span class="keyword">case</span> <span class="string">'subject'</span>
0042         <span class="keyword">for</span> i=1:length(aap.acq_details.subjects)
0043             doneflag=fullfile(<a href="aas_getsubjpath.html" class="code" title="function [subjpath]=aas_getsubjpath(aap,i)">aas_getsubjpath</a>(aap,i),[<span class="string">'done_'</span> aap.tasklist.stages{k}.name]);
0044             <span class="keyword">if</span> (length(dir(doneflag)))
0045                 <span class="keyword">if</span> (strcmp(task,<span class="string">'doit'</span>))
0046                     <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'- completed previously: %s for subject %s'</span>,description,aap.acq_details.subjects{i}));
0047                 <span class="keyword">end</span>;
0048             <span class="keyword">else</span>
0049                 <span class="keyword">switch</span> (task)
0050                     <span class="keyword">case</span> <span class="string">'checkrequirements'</span>
0051                         [aap,resp]=feval(aap.tasklist.stages{k}.name,aap,task,i);
0052                         <span class="keyword">if</span> (length(resp)&gt;0)
0053                             <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,[<span class="string">'\n***WARNING: '</span> resp]);
0054                         <span class="keyword">end</span>;
0055                     <span class="keyword">case</span> <span class="string">'doit'</span>
0056                         tic
0057                         <span class="comment">% before starting current stage, delete done_</span>
0058                         <span class="comment">% flag for next one</span>
0059                         <span class="keyword">if</span> (k&lt;length(aap.tasklist.stages))
0060                             <a href="#_sub2" class="code" title="subfunction delete_doneflag(aap,stage,inpi)">delete_doneflag</a>(aap,k+1,i);
0061                         <span class="keyword">end</span>;
0062                         <span class="comment">% now run current stage</span>
0063                         <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'MODULE %s RUNNING: %s for subject %s'</span>,aap.tasklist.stages{k}.name,description,aap.acq_details.subjects{i}));
0064                         [aap,resp]=feval(aap.tasklist.stages{k}.name,aap,task,i);
0065                         <a href="#_sub1" class="code" title="subfunction writedoneflag(aap,fn)">writedoneflag</a>(aap,doneflag);
0066                         <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'MODULE %s COMPLETED'</span>,aap.tasklist.stages{k}.name));
0067                 <span class="keyword">end</span>;
0068             <span class="keyword">end</span>;
0069         <span class="keyword">end</span>;
0070     <span class="keyword">case</span> <span class="string">'session'</span>
0071 
0072         <span class="keyword">for</span> i=1:length(aap.acq_details.subjects)
0073             <span class="keyword">for</span> j=1:length(aap.acq_details.sessions)
0074                 doneflag=fullfile(<a href="aas_getsesspath.html" class="code" title="function [sesspath]=aas_getsesspath(aap,i,j)">aas_getsesspath</a>(aap,i,j),[<span class="string">'done_'</span> aap.tasklist.stages{k}.name]);
0075                 <span class="keyword">if</span> (length(dir(doneflag)))
0076                     <span class="keyword">if</span> (strcmp(task,<span class="string">'doit'</span>))
0077                         <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'- completed previously: %s for subject %s session %s'</span>,description,aap.acq_details.subjects{i},aap.acq_details.sessions{j}));
0078                     <span class="keyword">end</span>;
0079                 <span class="keyword">else</span>
0080                     <span class="keyword">switch</span> (task)
0081                         <span class="keyword">case</span> <span class="string">'checkrequirements'</span>
0082                             [aap,resp]=feval(aap.tasklist.stages{k}.name,aap,task,i,j);
0083                             <span class="keyword">if</span> (length(resp)&gt;0)
0084                                 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,[<span class="string">'\n***WARNING: '</span> resp]);
0085                             <span class="keyword">end</span>;
0086                         <span class="keyword">case</span> <span class="string">'doit'</span>
0087                             tic
0088                             <span class="comment">% before starting current stage, delete done_</span>
0089                             <span class="comment">% flag for next one</span>
0090                             <span class="keyword">if</span> (k&lt;length(aap.tasklist.stages))
0091                                 <a href="#_sub2" class="code" title="subfunction delete_doneflag(aap,stage,inpi)">delete_doneflag</a>(aap,k+1,i);
0092                             <span class="keyword">end</span>;
0093                             <span class="comment">% now run current stage</span>
0094                             <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'MODULE %s RUNNING: %s for subject %s session %s'</span>,aap.tasklist.stages{k}.name,description,aap.acq_details.subjects{i},aap.acq_details.sessions{j}));
0095                             [aap,resp]=feval(aap.tasklist.stages{k}.name,aap,task,i,j);
0096                             <a href="#_sub1" class="code" title="subfunction writedoneflag(aap,fn)">writedoneflag</a>(aap,doneflag);
0097                             <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'MODULE %s COMPLETED'</span>,aap.tasklist.stages{k}.name));
0098                     <span class="keyword">end</span>;
0099                 <span class="keyword">end</span>;
0100             <span class="keyword">end</span>;
0101         <span class="keyword">end</span>;
0102     <span class="keyword">otherwise</span>
0103         <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,1,sprintf(<span class="string">'Unknown domain %s associated with stage %s'</span>,aap.tasklist.domain{k},aap.tasklist.stages{k}.name));
0104 <span class="keyword">end</span>;
0105 
0106 <a name="_sub1" href="#_subfunctions" class="code">function writedoneflag(aap,fn)</a>
0107 fid=fopen(fn,<span class="string">'w'</span>);
0108 <span class="keyword">if</span> (~fid)
0109     <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,1,[<span class="string">'Error writing done flag '</span> fn])
0110 <span class="keyword">end</span>;
0111 fprintf(fid,<span class="string">'%f'</span>,toc);
0112 fclose(fid);
0113 <span class="keyword">return</span>;
0114 
0115 <a name="_sub2" href="#_subfunctions" class="code">function delete_doneflag(aap,stage,inpi)</a>
0116 <span class="comment">% find out whether this module needs to be executed once per study, subject</span>
0117 <span class="comment">% or session</span>
0118 [aap,domain]=feval(aap.tasklist.stages{stage}.name,aap,<span class="string">'domain'</span>);
0119 <span class="keyword">if</span> (inpi&lt;=0)
0120     boti=1;
0121     topi=length(aap.acq_details.subjects);
0122 <span class="keyword">else</span>
0123     boti=inpi;
0124     topi=inpi;
0125 <span class="keyword">end</span>;
0126 <span class="keyword">switch</span> (domain)
0127     <span class="keyword">case</span> <span class="string">'study'</span>
0128         doneflag=fullfile(aap.acq_details.root,[<span class="string">'done_'</span> aap.tasklist.stages{stage}.name]);
0129         <span class="keyword">if</span> (exist(doneflag,<span class="string">'file'</span>))
0130             cmd=[<span class="string">'rm '</span> doneflag];
0131             [s w]=<a href="aas_shell.html" class="code" title="function [s,w]=aas_shell(cmd)">aas_shell</a>(cmd);
0132             <span class="keyword">if</span> (s~=0)
0133                 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,1,w);
0134             <span class="keyword">end</span>;      
0135         <span class="keyword">end</span>;
0136         
0137     <span class="keyword">case</span> <span class="string">'subject'</span>
0138         
0139         <span class="keyword">for</span> i=boti:topi
0140             doneflag=fullfile(<a href="aas_getsubjpath.html" class="code" title="function [subjpath]=aas_getsubjpath(aap,i)">aas_getsubjpath</a>(aap,i),[<span class="string">'done_'</span> aap.tasklist.stages{stage}.name]);     
0141             <span class="keyword">if</span> (exist(doneflag,<span class="string">'file'</span>))
0142                 cmd=[<span class="string">'rm '</span> doneflag];
0143                 [s w]=<a href="aas_shell.html" class="code" title="function [s,w]=aas_shell(cmd)">aas_shell</a>(cmd);
0144                 <span class="keyword">if</span> (s~=0)
0145                     <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,1,w);
0146                 <span class="keyword">end</span>; 
0147             <span class="keyword">end</span>;
0148         <span class="keyword">end</span>;    
0149         
0150     <span class="keyword">case</span> <span class="string">'session'</span>
0151         <span class="keyword">for</span> i=boti:topi
0152             <span class="keyword">for</span> j=1:length(aap.acq_details.sessions)
0153                 doneflag=fullfile(<a href="aas_getsesspath.html" class="code" title="function [sesspath]=aas_getsesspath(aap,i,j)">aas_getsesspath</a>(aap,i,j),[<span class="string">'done_'</span> aap.tasklist.stages{stage}.name]);
0154                 <span class="keyword">if</span> (exist(doneflag,<span class="string">'file'</span>))
0155                     cmd=[<span class="string">'rm '</span> doneflag];
0156                     [s w]=<a href="aas_shell.html" class="code" title="function [s,w]=aas_shell(cmd)">aas_shell</a>(cmd);
0157                     <span class="keyword">if</span> (s~=0)
0158                         <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,1,w);
0159                     <span class="keyword">end</span>; 
0160                 <span class="keyword">end</span>;     
0161             <span class="keyword">end</span>;
0162         <span class="keyword">end</span>;
0163 <span class="keyword">end</span>;
0164</pre></div>
<hr><address>Generated on Fri 31-Aug-2007 16:39:50 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>