<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of aa_doprocessing_parallel</title>
  <meta name="keywords" content="aa_doprocessing_parallel">
  <meta name="description" content="Automatic analysis - do processing">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="#">aa_engine</a> &gt; aa_doprocessing_parallel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ./aa_engine&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>aa_doprocessing_parallel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Automatic analysis - do processing</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [aap]=aa_doprocessing_parallel(aap) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Automatic analysis - do processing
 Main engine which runs different stages
 Pass parameter file set up in aa_user.m with help of recipes.
 Rhodri Cusack MRC CBU Cambridge 2004</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="aa_closeallworkers.html" class="code" title="function aa_closeallworkers()">aa_closeallworkers</a>	aa parallel</li><li><a href="aas_doprocessing_initialisationmodules.html" class="code" title="function [aap]=aas_doprocessing_initialisationmodules(aap)">aas_doprocessing_initialisationmodules</a>	THE MODULES LISTED IN AAP.TASKLIST.INITIALISATIONMODULES ARE ALWAYS RUN</li><li><a href="aas_getboredworker.html" class="code" title="function [aap workerid]=aas_getboredworker(aap)">aas_getboredworker</a>	</li><li><a href="aas_getsesspath.html" class="code" title="function [sesspath]=aas_getsesspath(aap,i,j)">aas_getsesspath</a>	Automatic analysis - get session path</li><li><a href="aas_getsubjpath.html" class="code" title="function [subjpath]=aas_getsubjpath(aap,i)">aas_getsubjpath</a>	Automatic analysis - get subject path</li><li><a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>	Automatic analysis - log tool</li><li><a href="aas_requiresversion.html" class="code" title="function aa_requiresversion(aap)">aas_requiresversion</a>	Automatic analysis - check version</li><li><a href="aas_shell.html" class="code" title="function [s,w]=aas_shell(cmd)">aas_shell</a>	function [s,w]=aas_shell(cmd)</li><li><a href="aaworker_getparmpath.html" class="code" title="function [pth]=aaworker_getparmpath(aap,aaworkerid,dontmakedir)">aaworker_getparmpath</a>	If third parameter is present and true, don't make path</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function writedoneflag(aap,fn)</a></li><li><a href="#_sub2" class="code">function delete_doneflag(aap,stage,inpi)</a></li><li><a href="#_sub3" class="code">function [aap]=taskqueue_clear(aap)</a></li><li><a href="#_sub4" class="code">function [aap]=taskqueue_add(aap,taskmask)</a></li><li><a href="#_sub5" class="code">function [aap]=taskqueue_runall(aap)</a></li><li><a href="#_sub6" class="code">function [aap]=taskqueue_runone(aap,i)</a></li><li><a href="#_sub7" class="code">function [k0 domain0]=gettobecompletedfirst(aap,k1,i,j)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% Automatic analysis - do processing</span>
0002 <span class="comment">% Main engine which runs different stages</span>
0003 <span class="comment">% Pass parameter file set up in aa_user.m with help of recipes.</span>
0004 <span class="comment">% Rhodri Cusack MRC CBU Cambridge 2004</span>
0005 
0006 
0007 <a name="_sub0" href="#_subfunctions" class="code">function [aap]=aa_doprocessing_parallel(aap)</a>
0008 
0009 <span class="keyword">global</span> defaults;
0010 <span class="keyword">global</span> aaparallel
0011 
0012 aap.internal.pwd=pwd;
0013 
0014 <span class="keyword">if</span> (isempty(aaparallel))
0015     <span class="keyword">while</span>(1)
0016         aaparallel.workerlist=[];
0017         aaparallel.numberofworkers=8;
0018         aaparallel.processkey=round(rand(1)*1e6);
0019         aaparallel.nextworkernumber=aaparallel.processkey*1000;
0020         pth=<a href="aaworker_getparmpath.html" class="code" title="function [pth]=aaworker_getparmpath(aap,aaworkerid,dontmakedir)">aaworker_getparmpath</a>(aap,0,true);
0021         [subpth nme ext]=fileparts(pth);
0022         fn=dir(fullfile(subpth,[<span class="string">'aaworker'</span> num2str(aaparallel.processkey) <span class="string">'*'</span>]));
0023         <span class="keyword">if</span> (length(fn)==0) <span class="comment">% No directories starting with this process key</span>
0024             <span class="keyword">break</span>;
0025         <span class="keyword">end</span>;
0026         
0027     <span class="keyword">end</span>;
0028 <span class="keyword">else</span>
0029     <span class="comment">% Clear out all of the old workers: this is non-unionised enterprise</span>
0030     <a href="aa_closeallworkers.html" class="code" title="function aa_closeallworkers()">aa_closeallworkers</a>;
0031 <span class="keyword">end</span>;
0032 
0033 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,[<span class="string">'AUTOMATIC ANALYSIS '</span> datestr(now)]);
0034 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,[<span class="string">'============================================================='</span>]);
0035 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'Parallel process ID %d'</span>,aaparallel.processkey));
0036 
0037 <span class="comment">% Copy SPM defaults from aap structure</span>
0038 defaults=aap.spm.defaults;
0039 
0040 <span class="comment">% Check AA version</span>
0041 <a href="aas_requiresversion.html" class="code" title="function aa_requiresversion(aap)">aas_requiresversion</a>(aap);
0042 
0043 aap=<a href="aas_doprocessing_initialisationmodules.html" class="code" title="function [aap]=aas_doprocessing_initialisationmodules(aap)">aas_doprocessing_initialisationmodules</a>(aap);
0044 
0045 <span class="comment">% Now saving AAP structure</span>
0046 aapsavefn=fullfile(aap.acq_details.root,<span class="string">'aap_parameters'</span>);
0047 <span class="keyword">if</span> (~length(dir(aap.acq_details.root)))
0048     [s w]=<a href="aas_shell.html" class="code" title="function [s,w]=aas_shell(cmd)">aas_shell</a>([<span class="string">'mkdir '</span> aap.acq_details.root]);
0049     <span class="keyword">if</span> (s)
0050         <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,1,sprintf(<span class="string">'Problem making directory%s'</span>,aap.acq_details.root));
0051     <span class="keyword">end</span>;
0052 <span class="keyword">end</span>;
0053 
0054 aap.internal.aapversion=which(<span class="string">'aa_doprocessing'</span>);
0055 save(aapsavefn,<span class="string">'aap'</span>);
0056 
0057 <span class="comment">% THE MODULES IN AAP.TASKLIST.STAGES ARE RUN IF A CORRESPONDING DONE_ FLAG</span>
0058 <span class="comment">% IS NOT FOUND. ONE IS CREATED AFTER SUCCESSFUL EXECUTION</span>
0059 <span class="comment">% Now run stage-by-stage tasks</span>
0060 
0061 aap=<a href="#_sub3" class="code" title="subfunction [aap]=taskqueue_clear(aap)">taskqueue_clear</a>(aap);
0062 
0063 mytasks={<span class="string">'checkrequirements'</span>,<span class="string">'doit'</span>};
0064 <span class="keyword">for</span> l=1:length(mytasks)
0065     <span class="keyword">for</span> k=1:length(aap.tasklist.stages)
0066         task=mytasks{l};
0067         aap.tasklist.currenttask.epiprefix=aap.tasklist.stages{k}.epiprefix;
0068         aap.tasklist.currenttask.extraparameters=aap.tasklist.stages{k}.extraparameters;
0069 
0070         <span class="comment">% retrieve description from module</span>
0071         [aap,description]=feval(aap.tasklist.stages{k}.name,aap,<span class="string">'description'</span>);
0072 
0073         <span class="comment">% find out whether this module needs to be executed once per study, subject or session</span>
0074         [aap,domain]=feval(aap.tasklist.stages{k}.name,aap,<span class="string">'domain'</span>);
0075 
0076         <span class="comment">% Start setting up the descriptor for the parallel queue</span>
0077         clear taskmask
0078         taskmask.domain=domain;
0079         taskmask.description=description;
0080         taskmask.k=k;
0081         taskmask.task=task;
0082 
0083         <span class="comment">% Now execute the module, and change the 'done' flags if task='doit'</span>
0084         <span class="keyword">switch</span> (domain)
0085             <span class="keyword">case</span> <span class="string">'study'</span>
0086                 doneflag=fullfile(aap.acq_details.root,[<span class="string">'done_'</span> aap.tasklist.stages{k}.name]);
0087                 <span class="keyword">if</span> (length(dir(doneflag)))
0088                     <span class="keyword">if</span> (strcmp(task,<span class="string">'doit'</span>))
0089                         <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'- completed previously: %s'</span>,description));
0090                     <span class="keyword">end</span>;
0091                 <span class="keyword">else</span>
0092                     <span class="keyword">switch</span> (task)
0093                         <span class="keyword">case</span> <span class="string">'checkrequirements'</span>
0094                             [aap,resp]=feval(aap.tasklist.stages{k}.name,aap,task);
0095                             <span class="keyword">if</span> (length(resp)&gt;0)
0096                                 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,[<span class="string">'\n***WARNING: '</span> resp]);
0097                             <span class="keyword">end</span>;
0098                         <span class="keyword">case</span> <span class="string">'doit'</span>
0099                             tic
0100                             <span class="comment">% before starting current stage, delete done_</span>
0101                             <span class="comment">% flag for next one</span>
0102                             <span class="keyword">if</span> (k&lt;length(aap.tasklist.stages))
0103                                 <a href="#_sub2" class="code" title="subfunction delete_doneflag(aap,stage,inpi)">delete_doneflag</a>(aap,k+1,-1);
0104                             <span class="keyword">end</span>;
0105 
0106                             <span class="comment">% work out what needs to be done before we can</span>
0107                             <span class="comment">% execute this stage</span>
0108                             [k0,domain0]=<a href="#_sub7" class="code" title="subfunction [k0 domain0]=gettobecompletedfirst(aap,k1,i,j)">gettobecompletedfirst</a>(aap,k);
0109                             tbcf=[];
0110                             <span class="keyword">switch</span>(domain0)
0111                                 <span class="keyword">case</span> <span class="string">'study'</span>
0112                                     tbcf={fullfile(aap.acq_details.root,[<span class="string">'done_'</span> aap.tasklist.stages{k0}.name])};
0113                                 <span class="keyword">case</span> <span class="string">'subject'</span>
0114                                     <span class="keyword">for</span> i=1:length(aap.acq_details.subjects)
0115                                         tbcf=[tbcf {fullfile(<a href="aas_getsubjpath.html" class="code" title="function [subjpath]=aas_getsubjpath(aap,i)">aas_getsubjpath</a>(aap,i),[<span class="string">'done_'</span> aap.tasklist.stages{k0}.name])}];
0116                                     <span class="keyword">end</span>;
0117                                 <span class="keyword">case</span> <span class="string">'session'</span>
0118                                     <span class="keyword">for</span> i=1:length(aap.acq_details.subjects)
0119                                         <span class="keyword">for</span> j=1:length(aap.acq_details.sessions)
0120                                             tbcf=[tbcf {fullfile(<a href="aas_getsesspath.html" class="code" title="function [sesspath]=aas_getsesspath(aap,i,j)">aas_getsesspath</a>(aap,i,j),[<span class="string">'done_'</span> aap.tasklist.stages{k0}.name])}];
0121                                         <span class="keyword">end</span>;
0122                                     <span class="keyword">end</span>;
0123                             <span class="keyword">end</span>;
0124                             taskmask.tobecompletedfirst=tbcf;
0125                             taskmask.i=0;
0126                             taskmask.j=0;
0127 
0128                             <span class="comment">% now queue current stage</span>
0129                             <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'MODULE %s QUEUED: %s'</span>,aap.tasklist.stages{k}.name,description));
0130                             taskmask.doneflag=doneflag;
0131                             aap=<a href="#_sub4" class="code" title="subfunction [aap]=taskqueue_add(aap,taskmask)">taskqueue_add</a>(aap,taskmask);
0132                     <span class="keyword">end</span>;
0133 
0134                 <span class="keyword">end</span>;
0135             <span class="keyword">case</span> <span class="string">'subject'</span>
0136                 <span class="keyword">for</span> i=1:length(aap.acq_details.subjects)
0137                     doneflag=fullfile(<a href="aas_getsubjpath.html" class="code" title="function [subjpath]=aas_getsubjpath(aap,i)">aas_getsubjpath</a>(aap,i),[<span class="string">'done_'</span> aap.tasklist.stages{k}.name]);
0138                     <span class="keyword">if</span> (length(dir(doneflag)))
0139                         <span class="keyword">if</span> (strcmp(task,<span class="string">'doit'</span>))
0140                             <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'- completed previously: %s for subject %s'</span>,description,aap.acq_details.subjects{i}));
0141                         <span class="keyword">end</span>;
0142                     <span class="keyword">else</span>
0143                         <span class="keyword">switch</span> (task)
0144                             <span class="keyword">case</span> <span class="string">'checkrequirements'</span>
0145                                 [aap,resp]=feval(aap.tasklist.stages{k}.name,aap,task,i);
0146                                 <span class="keyword">if</span> (length(resp)&gt;0)
0147                                     <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,[<span class="string">'\n***WARNING: '</span> resp]);
0148                                 <span class="keyword">end</span>;
0149                             <span class="keyword">case</span> <span class="string">'doit'</span>
0150                                 tic
0151                                 <span class="comment">% before starting current stage, delete done_</span>
0152                                 <span class="comment">% flag for next one</span>
0153                                 <span class="keyword">if</span> (k&lt;length(aap.tasklist.stages))
0154                                     <a href="#_sub2" class="code" title="subfunction delete_doneflag(aap,stage,inpi)">delete_doneflag</a>(aap,k+1,i);
0155                                 <span class="keyword">end</span>;
0156 
0157                                 <span class="comment">% work out what needs to be done before we can</span>
0158                                 <span class="comment">% execute this stage</span>
0159                                 [k0,domain0]=<a href="#_sub7" class="code" title="subfunction [k0 domain0]=gettobecompletedfirst(aap,k1,i,j)">gettobecompletedfirst</a>(aap,k);
0160                                 tbcf=[];
0161                                 <span class="keyword">switch</span>(domain0)
0162                                     <span class="keyword">case</span> <span class="string">'study'</span>
0163                                         tbcf={fullfile(aap.acq_details.root,[<span class="string">'done_'</span> aap.tasklist.stages{k0}.name])};
0164                                     <span class="keyword">case</span> <span class="string">'subject'</span>
0165                                         tbcf=[tbcf {fullfile(<a href="aas_getsubjpath.html" class="code" title="function [subjpath]=aas_getsubjpath(aap,i)">aas_getsubjpath</a>(aap,i),[<span class="string">'done_'</span> aap.tasklist.stages{k0}.name])}];
0166                                     <span class="keyword">case</span> <span class="string">'session'</span>
0167                                         <span class="keyword">for</span> j=1:length(aap.acq_details.sessions)
0168                                             tbcf=[tbcf {fullfile(<a href="aas_getsesspath.html" class="code" title="function [sesspath]=aas_getsesspath(aap,i,j)">aas_getsesspath</a>(aap,i,j),[<span class="string">'done_'</span> aap.tasklist.stages{k0}.name])}];
0169                                         <span class="keyword">end</span>;
0170                                 <span class="keyword">end</span>;
0171                                 taskmask.tobecompletedfirst=tbcf;
0172 
0173                                 <span class="comment">% now queue current stage</span>
0174                                 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'MODULE %s QUEUED: %s for subject %s'</span>,aap.tasklist.stages{k}.name,description,aap.acq_details.subjects{i}));
0175 
0176                                 taskmask.i=i;
0177                                 taskmask.j=0;
0178                                 taskmask.doneflag=doneflag;
0179                                 aap=<a href="#_sub4" class="code" title="subfunction [aap]=taskqueue_add(aap,taskmask)">taskqueue_add</a>(aap,taskmask);
0180                         <span class="keyword">end</span>;
0181                     <span class="keyword">end</span>;
0182                 <span class="keyword">end</span>;
0183 
0184             <span class="keyword">case</span> <span class="string">'session'</span>
0185                 <span class="keyword">for</span> i=1:length(aap.acq_details.subjects)
0186                     <span class="keyword">for</span> j=1:length(aap.acq_details.sessions)
0187                         doneflag=fullfile(<a href="aas_getsesspath.html" class="code" title="function [sesspath]=aas_getsesspath(aap,i,j)">aas_getsesspath</a>(aap,i,j),[<span class="string">'done_'</span> aap.tasklist.stages{k}.name]);
0188                         <span class="keyword">if</span> (length(dir(doneflag)))
0189                             <span class="keyword">if</span> (strcmp(task,<span class="string">'doit'</span>))
0190                                 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'- completed previously: %s for subject %s session %s'</span>,description,aap.acq_details.subjects{i},aap.acq_details.sessions{j}));
0191                             <span class="keyword">end</span>;
0192                         <span class="keyword">else</span>
0193                             <span class="keyword">switch</span> (task)
0194                                 <span class="keyword">case</span> <span class="string">'checkrequirements'</span>
0195                                     [aap,resp]=feval(aap.tasklist.stages{k}.name,aap,task,i,j);
0196                                     <span class="keyword">if</span> (length(resp)&gt;0)
0197                                         <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,[<span class="string">'\n***WARNING: '</span> resp]);
0198                                     <span class="keyword">end</span>;
0199                                 <span class="keyword">case</span> <span class="string">'doit'</span>
0200                                     tic
0201                                     <span class="comment">% before starting current stage, delete done_</span>
0202                                     <span class="comment">% flag for next one</span>
0203                                     <span class="keyword">if</span> (k&lt;length(aap.tasklist.stages))
0204                                         <a href="#_sub2" class="code" title="subfunction delete_doneflag(aap,stage,inpi)">delete_doneflag</a>(aap,k+1,i);
0205                                     <span class="keyword">end</span>;
0206 
0207                                     <span class="comment">% work out what needs to be done before we can</span>
0208                                     <span class="comment">% execute this stage</span>
0209                                     [k0,domain0]=<a href="#_sub7" class="code" title="subfunction [k0 domain0]=gettobecompletedfirst(aap,k1,i,j)">gettobecompletedfirst</a>(aap,k);
0210                                     tbcf=[];
0211                                     <span class="keyword">switch</span>(domain0)
0212                                         <span class="keyword">case</span> <span class="string">'study'</span>
0213                                             tbcf={fullfile(aap.acq_details.root,[<span class="string">'done_'</span> aap.tasklist.stages{k0}.name])};
0214                                         <span class="keyword">case</span> <span class="string">'subject'</span>
0215                                             tbcf=[tbcf {fullfile(<a href="aas_getsubjpath.html" class="code" title="function [subjpath]=aas_getsubjpath(aap,i)">aas_getsubjpath</a>(aap,i),[<span class="string">'done_'</span> aap.tasklist.stages{k0}.name])}];
0216                                         <span class="keyword">case</span> <span class="string">'session'</span>
0217                                             tbcf=[tbcf {fullfile(<a href="aas_getsesspath.html" class="code" title="function [sesspath]=aas_getsesspath(aap,i,j)">aas_getsesspath</a>(aap,i,j),[<span class="string">'done_'</span> aap.tasklist.stages{k0}.name])}];
0218                                     <span class="keyword">end</span>;
0219                                     taskmask.tobecompletedfirst=tbcf;
0220 
0221                                     <span class="comment">% now queue current stage</span>
0222                                     <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,0,sprintf(<span class="string">'MODULE %s QUEUED: %s for subject %s session %s'</span>,aap.tasklist.stages{k}.name,description,aap.acq_details.subjects{i},aap.acq_details.sessions{j}));
0223                                     taskmask.i=i;
0224                                     taskmask.j=j;
0225                                     taskmask.doneflag=doneflag;
0226                                     aap=<a href="#_sub4" class="code" title="subfunction [aap]=taskqueue_add(aap,taskmask)">taskqueue_add</a>(aap,taskmask);
0227                             <span class="keyword">end</span>;
0228                         <span class="keyword">end</span>;
0229                     <span class="keyword">end</span>;
0230                 <span class="keyword">end</span>;
0231 
0232 
0233             <span class="keyword">otherwise</span>
0234                 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,1,sprintf(<span class="string">'Unknown domain %s associated with stage %s'</span>,aap.tasklist.domain{k},aap.tasklist.stages{k}.name));
0235         <span class="keyword">end</span>;
0236     <span class="keyword">end</span>;
0237 <span class="keyword">end</span>;
0238 
0239 aap=<a href="#_sub5" class="code" title="subfunction [aap]=taskqueue_runall(aap)">taskqueue_runall</a>(aap);
0240 <span class="keyword">return</span>;
0241 
0242 
0243 <a name="_sub1" href="#_subfunctions" class="code">function writedoneflag(aap,fn)</a>
0244 fid=fopen(fn,<span class="string">'w'</span>);
0245 <span class="keyword">if</span> (~fid)
0246     <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,1,[<span class="string">'Error writing done flag '</span> fn])
0247 <span class="keyword">end</span>;
0248 fprintf(fid,<span class="string">'%f'</span>,toc);
0249 fclose(fid);
0250 <span class="keyword">return</span>;
0251 
0252 <a name="_sub2" href="#_subfunctions" class="code">function delete_doneflag(aap,stage,inpi)</a>
0253 <span class="comment">% find out whether this module needs to be executed once per study, subject</span>
0254 <span class="comment">% or session</span>
0255 [aap,domain]=feval(aap.tasklist.stages{stage}.name,aap,<span class="string">'domain'</span>);
0256 <span class="keyword">if</span> (inpi&lt;=0)
0257     boti=1;
0258     topi=length(aap.acq_details.subjects);
0259 <span class="keyword">else</span>
0260     boti=inpi;
0261     topi=inpi;
0262 <span class="keyword">end</span>;
0263 <span class="keyword">switch</span> (domain)
0264     <span class="keyword">case</span> <span class="string">'study'</span>
0265         doneflag=fullfile(aap.acq_details.root,[<span class="string">'done_'</span> aap.tasklist.stages{stage}.name]);
0266         <span class="keyword">if</span> (exist(doneflag,<span class="string">'file'</span>))
0267             cmd=[<span class="string">'rm '</span> doneflag];
0268             [s w]=<a href="aas_shell.html" class="code" title="function [s,w]=aas_shell(cmd)">aas_shell</a>(cmd);
0269             <span class="keyword">if</span> (s~=0)
0270                 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,1,w);
0271             <span class="keyword">end</span>;
0272         <span class="keyword">end</span>;
0273 
0274     <span class="keyword">case</span> <span class="string">'subject'</span>
0275 
0276         <span class="keyword">for</span> i=boti:topi
0277             doneflag=fullfile(<a href="aas_getsubjpath.html" class="code" title="function [subjpath]=aas_getsubjpath(aap,i)">aas_getsubjpath</a>(aap,i),[<span class="string">'done_'</span> aap.tasklist.stages{stage}.name]);
0278             <span class="keyword">if</span> (exist(doneflag,<span class="string">'file'</span>))
0279                 cmd=[<span class="string">'rm '</span> doneflag];
0280                 [s w]=<a href="aas_shell.html" class="code" title="function [s,w]=aas_shell(cmd)">aas_shell</a>(cmd);
0281                 <span class="keyword">if</span> (s~=0)
0282                     <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,1,w);
0283                 <span class="keyword">end</span>;
0284             <span class="keyword">end</span>;
0285         <span class="keyword">end</span>;
0286 
0287     <span class="keyword">case</span> <span class="string">'session'</span>
0288         <span class="keyword">for</span> i=boti:topi
0289             <span class="keyword">for</span> j=1:length(aap.acq_details.sessions)
0290                 doneflag=fullfile(<a href="aas_getsesspath.html" class="code" title="function [sesspath]=aas_getsesspath(aap,i,j)">aas_getsesspath</a>(aap,i,j),[<span class="string">'done_'</span> aap.tasklist.stages{stage}.name]);
0291                 <span class="keyword">if</span> (exist(doneflag,<span class="string">'file'</span>))
0292                     cmd=[<span class="string">'rm '</span> doneflag];
0293                     [s w]=<a href="aas_shell.html" class="code" title="function [s,w]=aas_shell(cmd)">aas_shell</a>(cmd);
0294                     <span class="keyword">if</span> (s~=0)
0295                         <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,1,w);
0296                     <span class="keyword">end</span>;
0297                 <span class="keyword">end</span>;
0298             <span class="keyword">end</span>;
0299         <span class="keyword">end</span>;
0300 <span class="keyword">end</span>;
0301 
0302 <a name="_sub3" href="#_subfunctions" class="code">function [aap]=taskqueue_clear(aap)</a>
0303 aap.internal.taskqueue=[];
0304 
0305 <a name="_sub4" href="#_subfunctions" class="code">function [aap]=taskqueue_add(aap,taskmask)</a>
0306 aap.internal.taskqueue=[aap.internal.taskqueue,taskmask];
0307 
0308 <a name="_sub5" href="#_subfunctions" class="code">function [aap]=taskqueue_runall(aap)</a>
0309 njobs=length(aap.internal.taskqueue);
0310 joblaunched=false(njobs,1);
0311 pendingjobs=true;
0312 <span class="keyword">while</span> (pendingjobs)
0313     pendingjobs=false;
0314     <span class="keyword">for</span> i=1:njobs
0315         <span class="keyword">if</span> (~joblaunched(i))
0316             pendingjobs=true;
0317             readytorun=true;
0318             <span class="keyword">for</span> j=1:length(aap.internal.taskqueue(i).tobecompletedfirst)
0319                 <span class="keyword">if</span> (~exist(aap.internal.taskqueue(i).tobecompletedfirst{j},<span class="string">'file'</span>))
0320                     readytorun=false;
0321                 <span class="keyword">end</span>;
0322             <span class="keyword">end</span>;
0323             <span class="keyword">if</span> (readytorun)
0324                 aap=<a href="#_sub6" class="code" title="subfunction [aap]=taskqueue_runone(aap,i)">taskqueue_runone</a>(aap,i);
0325                 joblaunched(i)=true;
0326             <span class="keyword">end</span>;
0327         <span class="keyword">end</span>;
0328     <span class="keyword">end</span>;
0329     pause(0.5);
0330 <span class="keyword">end</span>;
0331 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,false,<span class="string">'PARALLEL all jobs submitted to workers, waiting for completion'</span>);
0332 
0333 aap=<a href="#_sub3" class="code" title="subfunction [aap]=taskqueue_clear(aap)">taskqueue_clear</a>(aap);
0334 
0335 
0336 <a name="_sub6" href="#_subfunctions" class="code">function [aap]=taskqueue_runone(aap,i)</a>
0337 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,false,sprintf(<span class="string">'PARALLEL waiting for free worker for job: %s'</span>,aap.internal.taskqueue(i).description));
0338 workerid=[];
0339 <span class="keyword">while</span>(isempty(workerid))
0340     [aap, workerid]=<a href="aas_getboredworker.html" class="code" title="function [aap workerid]=aas_getboredworker(aap)">aas_getboredworker</a>(aap);
0341     <span class="keyword">if</span> (isempty(workerid))
0342         pause(0.5);
0343     <span class="keyword">end</span>;
0344 <span class="keyword">end</span>;
0345 <span class="comment">% Now communicate with the worker</span>
0346 workerpth=<a href="aaworker_getparmpath.html" class="code" title="function [pth]=aaworker_getparmpath(aap,aaworkerid,dontmakedir)">aaworker_getparmpath</a>(aap,workerid);
0347 clear task;
0348 task.name=<span class="string">'doprocessing'</span>;
0349 task.aap=aap;
0350 task.aap.tasklist.currenttask.epiprefix=aap.tasklist.stages{aap.internal.taskqueue(i).k}.epiprefix;
0351 task.aap.tasklist.currenttask.extraparameters=aap.tasklist.stages{aap.internal.taskqueue(i).k}.extraparameters;
0352 task.aap.internal.taskqueue=aap.internal.taskqueue(i);
0353 save(fullfile(workerpth,<span class="string">'pendingtask'</span>),<span class="string">'task'</span>);
0354 <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,false,sprintf(<span class="string">'  ...sent to worker %d'</span>,workerid));
0355 
0356 
0357 <a name="_sub7" href="#_subfunctions" class="code">function [k0 domain0]=gettobecompletedfirst(aap,k1,i,j)</a>
0358 
0359 <span class="comment">% first stage has no dependencies</span>
0360 <span class="keyword">if</span> (k1==1)
0361     k0=[];
0362     domain0=<span class="string">''</span>;
0363     <span class="keyword">return</span>;
0364 <span class="keyword">end</span>;
0365 
0366 <span class="comment">% previous stage, or something elsE?</span>
0367 tobecompletedfirst=aap.tasklist.stages{k1}.tobecompletedfirst;
0368 <span class="keyword">if</span> (strcmp(tobecompletedfirst,<span class="string">'[previous]'</span>))
0369     k0=k1-1;
0370 <span class="keyword">else</span>
0371     <span class="keyword">for</span> k0=1:(k1-1)
0372         <span class="keyword">if</span> strcmp(aap.tasklist.stages{k0}.name,tobecompletedfirst)
0373             <span class="keyword">break</span>;
0374         <span class="keyword">end</span>;
0375     <span class="keyword">end</span>;
0376     <span class="keyword">if</span> (k0==k1)
0377         <a href="aas_log.html" class="code" title="function aas_log(aap,iserr,msg)">aas_log</a>(aap,false,sprintf(<span class="string">'stage %s is only to be executed after %s but this is not in the task list'</span>,aap.tasklist.stages(k1),tobecompleted));
0378     <span class="keyword">end</span>;
0379 <span class="keyword">end</span>;
0380 
0381 <span class="comment">% now find out what domain the done flags need to cover</span>
0382 [aap,domain0]=feval(aap.tasklist.stages{k0}.name,aap,<span class="string">'domain'</span>);
0383 
0384 
0385</pre></div>
<hr><address>Generated on Fri 31-Aug-2007 16:39:50 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>