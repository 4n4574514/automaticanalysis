<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of aamod_autoidentifyseries_timtrio</title>
  <meta name="keywords" content="aamod_autoidentifyseries_timtrio">
  <meta name="description" content="AA initialisation module - Identify dicom headers from Tim Trio">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="#">aa_modules</a> &gt; aamod_autoidentifyseries_timtrio.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ./aa_modules&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>aamod_autoidentifyseries_timtrio
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>AA initialisation module - Identify dicom headers from Tim Trio</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function  [aap,resp]=aamod_autoidentifyseries_trio(aap,task,i) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> AA initialisation module - Identify dicom headers from Tim Trio
 Rhodri Cusack MRC CBU Cambridge Dec 2005</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% AA initialisation module - Identify dicom headers from Tim Trio</span>
0002 <span class="comment">% Rhodri Cusack MRC CBU Cambridge Dec 2005</span>
0003 
0004 <a name="_sub0" href="#_subfunctions" class="code">function  [aap,resp]=aamod_autoidentifyseries_trio(aap,task,i)</a>
0005 
0006 resp=<span class="string">''</span>;
0007 
0008 <span class="keyword">switch</span> task
0009     <span class="keyword">case</span> <span class="string">'domain'</span>
0010         resp=<span class="string">'subject'</span>;   <span class="comment">% this module needs to be run once per subject</span>
0011 
0012     <span class="keyword">case</span> <span class="string">'description'</span>
0013         resp=<span class="string">'Automatically identify series numbers'</span>;
0014 
0015     <span class="keyword">case</span> <span class="string">'summary'</span>
0016         resp=[];
0017         numresp=0;
0018         <span class="keyword">if</span> (aap.options.autoidentifyfieldmaps)
0019             resp{1}=<span class="string">'fieldmaps'</span>;
0020             numresp=numresp+1;
0021         <span class="keyword">end</span>;
0022         <span class="keyword">if</span> (aap.options.autoidentifystructural)
0023             resp{numresp}=<span class="string">'structural'</span>;
0024             numresp=numresp+1;
0025         <span class="keyword">end</span>;
0026         <span class="keyword">if</span> (aap.options.autoidentifytmaps)
0027             resp{numresp}=<span class="string">'realtime t-maps'</span>;
0028             numresp=numresp+1;
0029         <span class="keyword">end</span>;
0030         <span class="keyword">switch</span> (numresp)
0031             <span class="keyword">case</span> 0
0032                 resp=[<span class="string">'No automatic identification done.'</span>];
0033             <span class="keyword">case</span> 1
0034                 resp=[<span class="string">'Automatically identified '</span> resp{1} <span class="string">'\n'</span>];
0035             <span class="keyword">case</span> 2
0036                 resp=[<span class="string">'Automatically identified '</span> resp{1} <span class="string">' and '</span> resp{2} <span class="string">'\n'</span>];
0037             <span class="keyword">case</span> 3
0038                 resp=[<span class="string">'Automatically identified '</span> resp{1} <span class="string">', '</span> resp{2} <span class="string">' and '</span> resp{3} <span class="string">'\n'</span>];
0039         <span class="keyword">end</span>;
0040     <span class="keyword">case</span> <span class="string">'report'</span>
0041 
0042     <span class="keyword">case</span> <span class="string">'doit'</span>
0043         dontrescan=false;
0044         aisfn=fullfile(aas_getsubjpath(aap,i),<span class="string">'autoidentifyseries_saved.mat'</span>);
0045         <span class="keyword">if</span> (length(dir(aisfn))&gt;0)
0046             aas_log(aap,0,sprintf(<span class="string">'Loading saved automatically identified series for %s'</span>,aap.acq_details.subjects{i}));
0047             savedseries=load(aisfn);
0048             series_spgr=savedseries.series_spgr;
0049             series_newfieldmap=savedseries.series_newfieldmap;
0050             series_tmaps=savedseries.series_tmaps;
0051             <span class="keyword">if</span> (savedseries.aapoptions.autoidentifystructural==aap.options.autoidentifystructural &amp; <span class="keyword">...</span>
0052                     savedseries.aapoptions.autoidentifyfieldmaps==aap.options.autoidentifyfieldmaps &amp; <span class="keyword">...</span>
0053                     savedseries.aapoptions.autoidentifytmaps==aap.options.autoidentifytmaps)
0054                 dontrescan=true;
0055             <span class="keyword">end</span>;
0056         <span class="keyword">end</span>;
0057         <span class="keyword">if</span> (~dontrescan)
0058             rawdata_subj=fullfile(aap.directory_conventions.rawdatadir,aap.acq_details.subjects{i});
0059             rawdata_allseries=dir(rawdata_subj);
0060 
0061             series_spgr=[];
0062             series_newfieldmap=[];
0063             series_tmaps=[];
0064 
0065             filenumber=0;
0066 
0067             <span class="keyword">for</span> j=1:length(rawdata_allseries)
0068 
0069                 <span class="comment">% load dicom header of first file</span>
0070                 <span class="keyword">if</span> (rawdata_allseries(j).isdir &amp; rawdata_allseries(j).name(1)~=<span class="string">'.'</span>)
0071                     filenumber=filenumber+1;
0072                     dicomfiles=dir(fullfile(rawdata_subj,rawdata_allseries(j).name));
0073                     <span class="keyword">for</span> k=1:length(dicomfiles)
0074                         <span class="keyword">if</span> (dicomfiles(k).name(1)~=<span class="string">'.'</span>)
0075                             <span class="keyword">break</span>;
0076                         <span class="keyword">end</span>;
0077                     <span class="keyword">end</span>;
0078                     hdr=spm_dicom_headers(fullfile(rawdata_subj,rawdata_allseries(j).name,dicomfiles(k).name));
0079                     <span class="keyword">if</span> (aap.directory_conventions.rawseries_usefileorder)
0080                         seriesnum=filenumber;
0081                     <span class="keyword">else</span>
0082                         seriesnum=str2num(rawdata_allseries(j).name(8:10));
0083                     <span class="keyword">end</span>;
0084 
0085                     <span class="comment">% Decide whether to ignore this series [djm 20/3/06]</span>
0086                     <span class="keyword">if</span> any(aap.acq_details.ignoreseries{i}==seriesnum)==0
0087 
0088                         <span class="keyword">if</span> (aap.options.autoidentifyfieldmaps)
0089                             <span class="keyword">if</span> (findstr(hdr{1}.ProtocolName,<span class="string">'CBU_FieldMapping'</span>))
0090                                 <span class="keyword">if</span> (length(series_newfieldmap)&gt;2)
0091                                     aas_log(aap,1,[<span class="string">'Automatic series id failed - more than a pair of Siemens fieldmap acquisition were found.'</span> sprintf(<span class="string">'%d\t'</span>,series_newfieldmap)]);
0092                                 <span class="keyword">end</span>;
0093                                 series_newfieldmap=[series_newfieldmap seriesnum];
0094                             <span class="keyword">end</span>;
0095                         <span class="keyword">end</span>;
0096 
0097                         <span class="keyword">if</span> (aap.options.autoidentifystructural)
0098                             <span class="keyword">if</span> (findstr(rawdata_allseries(j).name,<span class="string">'CBU_MPRAGE'</span>))
0099                                 <span class="keyword">if</span> (series_spgr &amp; aap.options.autoidentifystructural_chooselast==0  &amp; aap.options.autoidentifystructural_average==0)
0100                                     aas_log(aap,1,<span class="string">'Automatic series id failed - more than one MPRAGE acquisition was found.'</span>);
0101                                 <span class="keyword">end</span>;
0102                                 series_spgr=[series_spgr seriesnum];
0103                             <span class="keyword">end</span>;
0104                         <span class="keyword">end</span>;
0105 
0106 
0107                         <span class="keyword">if</span> (aap.options.autoidentifytmaps)
0108                             <span class="comment">% Use directory name rather than protocol to</span>
0109                             <span class="comment">% recognise t maps</span>
0110                             <span class="keyword">if</span> (findstr(rawdata_allseries(j).name,<span class="string">'EvaSeries_tTest'</span>))
0111                                 series_tmaps=[series_tmaps seriesnum];
0112                             <span class="keyword">end</span>;
0113                         <span class="keyword">end</span>;
0114                     <span class="keyword">end</span>;
0115                 <span class="keyword">end</span>;
0116             <span class="keyword">end</span>;
0117 
0118             [ais_p ais_f ais_e]=fileparts(aisfn);
0119             <span class="keyword">if</span> (length(dir(ais_p))&gt;0)
0120                 aapoptions=aap.options;
0121                 save(aisfn,<span class="string">'series_newfieldmap'</span>,<span class="string">'series_spgr'</span>,<span class="string">'series_tmaps'</span>,<span class="string">'aapoptions'</span>);
0122             <span class="keyword">end</span>;
0123         <span class="keyword">end</span>;
0124         comment=[];
0125         <span class="keyword">if</span> (aap.options.autoidentifyfieldmaps)
0126             aap.acq_details.siemensfieldmap{i}={};
0127             <span class="keyword">if</span> (length(series_newfieldmap)==2)
0128                 comment=[comment <span class="string">' '</span> sprintf(<span class="string">'gre_fieldmapping found %d and %d'</span>,series_newfieldmap(1),series_newfieldmap(2))];
0129                 aap.acq_details.siemensfieldmap{i}=series_newfieldmap;
0130             <span class="keyword">else</span>
0131                 aas_log(aap,1,<span class="string">'Automatic series id failed - one of the fieldmap acquisitions was not found.'</span>);
0132             <span class="keyword">end</span>;
0133         <span class="keyword">end</span>;
0134 
0135 
0136         <span class="keyword">if</span> (aap.options.autoidentifystructural)
0137             <span class="keyword">if</span> (aap.options.autoidentifystructural_chooselast &amp; length(series_spgr)&gt;1)                
0138                 series_spgr=series_spgr(length(series_spgr));
0139             <span class="keyword">end</span>;
0140             aap.acq_details.structural{i}=series_spgr;
0141             comment=[comment sprintf(<span class="string">' Structural series %d '</span>,series_spgr)];
0142         <span class="keyword">end</span>;
0143 
0144         <span class="keyword">if</span> (aap.options.autoidentifytmaps)
0145             aap.acq_details.tmaps{i}=series_tmaps;
0146             comment=[comment [<span class="string">' T maps series '</span> sprintf(<span class="string">'%d\t'</span>,series_tmaps)]];
0147         <span class="keyword">end</span>;
0148         <span class="keyword">if</span> (length(comment)&gt;0) aas_log(aap,0,comment); <span class="keyword">end</span>;
0149     <span class="keyword">case</span> <span class="string">'checkrequirements'</span>
0150 
0151     <span class="keyword">otherwise</span>
0152         aas_log(aap,1,sprintf(<span class="string">'Unknown task %s'</span>,task));
0153 <span class="keyword">end</span>;</pre></div>
<hr><address>Generated on Fri 31-Aug-2007 16:39:50 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>