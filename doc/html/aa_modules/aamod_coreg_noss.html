<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of aamod_coreg_noss</title>
  <meta name="keywords" content="aamod_coreg_noss">
  <meta name="description" content="AA module - coregister structural to mean EPI">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="#">aa_modules</a> &gt; aamod_coreg_noss.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ./aa_modules&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>aamod_coreg_noss
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>AA module - coregister structural to mean EPI</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [aap,resp]=aamod_coreg(aap,task,i) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> AA module - coregister structural to mean EPI 
 Coregistration of structural to mean EPI output by realignment
 Does not require skull stripping any more
 Modified for sparse imaging since prefix for mean is different
 i=subject num
 Rhodri Cusack MRC CBU 2004-6 based on original by Matthew Brett</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% AA module - coregister structural to mean EPI</span>
0002 <span class="comment">% Coregistration of structural to mean EPI output by realignment</span>
0003 <span class="comment">% Does not require skull stripping any more</span>
0004 <span class="comment">% Modified for sparse imaging since prefix for mean is different</span>
0005 <span class="comment">% i=subject num</span>
0006 <span class="comment">% Rhodri Cusack MRC CBU 2004-6 based on original by Matthew Brett</span>
0007 
0008 
0009 <a name="_sub0" href="#_subfunctions" class="code">function [aap,resp]=aamod_coreg(aap,task,i)</a>
0010 
0011 resp=<span class="string">''</span>;
0012 
0013 <span class="keyword">switch</span> task
0014     <span class="keyword">case</span> <span class="string">'domain'</span>
0015         resp=<span class="string">'subject'</span>;
0016     <span class="keyword">case</span> <span class="string">'description'</span>
0017         resp=<span class="string">'SPM5 coregister EPI to structural without skull stripping'</span>;
0018     <span class="keyword">case</span> <span class="string">'summary'</span>
0019         resp=<span class="string">'Done SPM5 coregistration of EPI to structural without skull stripping\n'</span>;
0020     <span class="keyword">case</span> <span class="string">'doit'</span>
0021         <span class="keyword">global</span> defaults;
0022         flags = defaults.coreg;
0023         <span class="comment">% check local structural directory exists</span>
0024         subjpath=aas_getsubjpath(aap,i);
0025         structdir=fullfile(subjpath,aap.directory_conventions.structdirname);
0026         <span class="keyword">if</span> (~length(dir(structdir)))
0027             [s w]=aas_shell([<span class="string">'mkdir '</span> structdir]);
0028             <span class="keyword">if</span> (s)
0029                 aas_log(aap,1,sprintf(<span class="string">'Problem making directory%s'</span>,structdir));
0030             <span class="keyword">end</span>;
0031         <span class="keyword">end</span>;
0032         
0033         <span class="comment">% dirnames,</span>
0034         <span class="comment">% get the subdirectories in the main directory</span>
0035         dirn = aas_getsesspath(aap,i,1);
0036         <span class="comment">% get undistorted mean in this directory</span>
0037         PG = aas_getimages(aap,i,1,[<span class="string">'mean*'</span>]);
0038         VG = spm_vol(PG);
0039         
0040         PF_local=[];
0041         <span class="comment">% Look for structural</span>
0042         structuralfilter=[<span class="string">'s'</span> aap.acq_details.subjects_structuralfn{i} <span class="string">'*.nii'</span>];
0043         <span class="comment">%  (1) in central store</span>
0044         structuralpath_central=aap.directory_conventions.centralstore_structurals;
0045         PF_central = dir(fullfile(structuralpath_central, structuralfilter));
0046         <span class="comment">% if more than one take first one</span>
0047         <span class="keyword">if</span> (length(PF_central)&gt;0)
0048             PF_central=PF_central(1);
0049         <span class="keyword">end</span>;
0050         <span class="comment">%  (2) in local subject directory</span>
0051         structuralpath_local=fullfile(aas_getsubjpath(aap,i),aap.directory_conventions.structdirname);
0052         PF_local = dir(fullfile( structuralpath_local, structuralfilter));
0053         
0054         <span class="keyword">if</span> (length(PF_central)==0 &amp; length(PF_local)~=0)
0055             <span class="comment">% copy from local to central</span>
0056             cmd=[<span class="string">'cp '</span> fullfile(structuralpath_local,structuralfilter ) <span class="string">' '</span> structuralpath_central];
0057             [s,w]=aas_shell(cmd);
0058             <span class="keyword">if</span> (s) 
0059                 aas_log(aap,1,sprintf(<span class="string">'Problem copying structural from central to local directory with command\n%s'</span>,cmd));
0060             <span class="keyword">end</span>;
0061         <span class="keyword">end</span>
0062         
0063         <span class="keyword">if</span> (length(PF_central)~=0 &amp; length(PF_local)==0)
0064             <span class="comment">% copy from central to local</span>
0065             <span class="comment">% In case there is more than one structural in central, only add files that are the same as in PF_central except for the</span>
0066             <span class="comment">% extension</span>
0067             PF_central_tmp=dir(fullfile(structuralpath_central,[<span class="string">'s'</span> aap.acq_details.subjects_structuralfn{i} <span class="string">'*.*'</span>]));
0068             
0069             <span class="keyword">for</span> l=1:length(PF_central)
0070                 cmd=[<span class="string">'cp '</span> fullfile(structuralpath_central,PF_central(l).name) <span class="string">' '</span> structuralpath_local]; 
0071                 [s,w]=aas_shell(cmd);
0072                 
0073                 <span class="keyword">if</span> (s) 
0074                     aas_log(aap,1,sprintf(<span class="string">'Problem copying structural from central to local directory with command\n%s'</span>,cmd));
0075                 <span class="keyword">end</span>;
0076             <span class="keyword">end</span>;
0077             PF_local = dir(fullfile(structuralpath_local, structuralfilter));
0078         <span class="keyword">end</span>
0079         
0080         <span class="keyword">if</span> (length(PF_local)==0)
0081             msg=sprintf(<span class="string">'Cannot find structural (without skull stripping) \nDirectory was %s\nFilter was %s\n'</span>,aap.directory_conventions.centralstore_structurals,structuralfilter);
0082             aas_log(aap,1,msg);            
0083         <span class="keyword">end</span>;
0084         
0085         VF = spm_vol(fullfile(structuralpath_local,PF_local(1).name));
0086         
0087         
0088         <span class="comment">% other images (=just the image to coregister)</span>
0089         PO = PF_local;
0090         
0091         <span class="comment">% do coregistration</span>
0092         x  = spm_coreg(VG, VF,flags.estimate);
0093         M  = inv(spm_matrix(x));
0094         MM = zeros(4,4,size(PO,1));
0095         <span class="keyword">for</span> j=1:length(PO),
0096             MM(:,:,j) = spm_get_space(fullfile(structuralpath_local,deblank(PO(j).name)));
0097         <span class="keyword">end</span>
0098         <span class="keyword">for</span> j=1:size(PO,1),
0099             spm_get_space(fullfile(structuralpath_local,deblank(PO(j).name)), M*MM(:,:,j));
0100         <span class="keyword">end</span>
0101         
0102         <span class="comment">% Save graphical output</span>
0103         figure(spm_figure(<span class="string">'FindWin'</span>));
0104         print(<span class="string">'-djpeg'</span>,<span class="string">'-r50'</span>,fullfile(aas_getsubjpath(aap,i),<span class="string">'diagnostic_aamod_coreg'</span>));
0105         
0106     <span class="keyword">case</span> <span class="string">'checkrequirements'</span>
0107         aas_log(aap,0,<span class="string">'No need to trim or skull strip structural\n'</span> );                    
0108 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 31-Aug-2007 16:39:50 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>