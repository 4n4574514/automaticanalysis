<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of aamod_norm_noss</title>
  <meta name="keywords" content="aamod_norm_noss">
  <meta name="description" content="AA module - normalisation using normalise or two pass procedure with segment">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="#">aa_modules</a> &gt; aamod_norm_noss.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ./aa_modules&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>aamod_norm_noss
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>AA module - normalisation using normalise or two pass procedure with segment</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [aap,resp]=aamod_norm_noss(aap,task,i) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> AA module - normalisation using normalise or two pass procedure with segment
 Depending on aap.spmanalysis.usesegmentnotnormalise
 If 0 - classic Normalisation
 If 1 - use Segment with two pass procedure: a first pass to correct
  for intensity variation across our structural images (probably due to
  inhomogeneous SNR across space of 12 channel coil); and a second pass
  to then do the segmentation
 _noss version does not use skull stripping
 i=subject num
 Rhodri Cusack &amp; Daniel Mitchell MRC CBU 2006
 based on originals by Rik Henson, Matthew Brett</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function savefields(fnam,p)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% AA module - normalisation using normalise or two pass procedure with segment</span>
0002 <span class="comment">% Depending on aap.spmanalysis.usesegmentnotnormalise</span>
0003 <span class="comment">% If 0 - classic Normalisation</span>
0004 <span class="comment">% If 1 - use Segment with two pass procedure: a first pass to correct</span>
0005 <span class="comment">%  for intensity variation across our structural images (probably due to</span>
0006 <span class="comment">%  inhomogeneous SNR across space of 12 channel coil); and a second pass</span>
0007 <span class="comment">%  to then do the segmentation</span>
0008 <span class="comment">% _noss version does not use skull stripping</span>
0009 <span class="comment">% i=subject num</span>
0010 <span class="comment">% Rhodri Cusack &amp; Daniel Mitchell MRC CBU 2006</span>
0011 <span class="comment">% based on originals by Rik Henson, Matthew Brett</span>
0012 
0013 <a name="_sub0" href="#_subfunctions" class="code">function [aap,resp]=aamod_norm_noss(aap,task,i)</a>
0014 
0015 resp=<span class="string">''</span>;
0016 
0017 <span class="keyword">switch</span> task
0018     <span class="keyword">case</span> <span class="string">'domain'</span>
0019         resp=<span class="string">'subject'</span>;
0020     <span class="keyword">case</span> <span class="string">'description'</span>
0021         resp=<span class="string">'SPM5 normalisation/segment'</span>;
0022     <span class="keyword">case</span> <span class="string">'summary'</span>
0023         resp=<span class="string">'Done SPM5 normalisation/segment of structural without skull stripping\n'</span>;
0024     <span class="keyword">case</span> <span class="string">'report'</span>
0025     
0026     <span class="keyword">case</span> <span class="string">'doit'</span>
0027         
0028         <span class="keyword">global</span> defaults;
0029         defs =defaults.normalise;
0030         defs.estimate.weight = <span class="string">''</span>;
0031 
0032         <span class="comment">% Template image; here template image not skull stripped</span>
0033         temp_imgs = aap.directory_conventions.T1template;
0034         
0035         clear imgs;
0036         subj_dir = aas_getsubjpath(aap,i);
0037         <span class="comment">% Get structural for this subject</span>
0038         structdir=fullfile(subj_dir,aap.directory_conventions.structdirname);
0039         subj.P = dir( fullfile(structdir,[<span class="string">'s'</span> aap.acq_details.subjects_structuralfn{i} <span class="string">'*.nii'</span>]));
0040         
0041         <span class="keyword">if</span> (length(subj.P)&gt;1)
0042             aas_log(aap,0,sprintf(<span class="string">'Found more than one structural so using first:\n%s'</span>,subj.P));
0043         <span class="keyword">end</span>;
0044         
0045         <span class="comment">% Set the mask for subject to empty by default</span>
0046         subj.objmask = <span class="string">''</span>; <span class="comment">% object mask</span>
0047         
0048         <span class="comment">% Get the images we are going to reslice</span>
0049         <span class="comment">% Because we are going reslice later (with undistort_reslice)</span>
0050         <span class="comment">% We don't reslice anything except the image to be normalized</span>
0051         subj.PP = subj.P;       
0052         
0053         <span class="comment">% call the SPM segment or normalize function to do the work</span>
0054         <span class="keyword">if</span> (aap.spmanalysis.usesegmentnotnormalise)    
0055             <span class="comment">% 2 stage process, as proposed by RH, to increased robustness [djm 13/03/06]</span>
0056             
0057             <span class="comment">%%%%%%%% 1st pass:</span>
0058             estopts.regtype=<span class="string">''</span>;    <span class="comment">% turn off affine:</span>
0059             out = spm_preproc(fullfile(structdir,subj.P(1).name),estopts);              
0060             [sn,isn]   = spm_prep2sn(out);
0061             
0062             <span class="comment">% only write out attenuation corrected image</span>
0063             writeopts.biascor = 1;
0064             writeopts.GM  = [0 0 0];
0065             writeopts.WM  = [0 0 0];
0066             writeopts.CSF = [0 0 0];
0067             writeopts.cleanup = [0];
0068             spm_preproc_write(sn,writeopts);
0069 
0070             <span class="comment">%%%%%%%% 2nd pass using attenuation corrected image</span>
0071             <span class="comment">% mstruc should be the attenuation corrected image</span>
0072             
0073             <span class="comment">% look for m prefixed filename</span>
0074             mstruc.P = dir( fullfile(structdir,[<span class="string">'ms'</span> aap.acq_details.subjects_structuralfn{i} <span class="string">'*.nii'</span>])); 
0075             <span class="keyword">if</span> (length(mstruc.P)&gt;1)
0076                 aas_log(aap,0,sprintf(<span class="string">'Found more than one attenuated structural so using first:\n%s'</span>,subj.P));
0077             <span class="keyword">end</span>;
0078             
0079             estopts.regtype=<span class="string">'mni'</span>;    <span class="comment">% turn on affine again</span>
0080             out = spm_preproc(fullfile(structdir,mstruc.P(1).name),estopts);           
0081             [sn,isn]   = spm_prep2sn(out);
0082             
0083             <span class="comment">% write out GM and WM native + unmod normalised</span>
0084             writeopts.biascor = 1;
0085             writeopts.GM  = [0 1 1];    
0086             writeopts.WM  = [0 1 1];
0087             writeopts.CSF = [0 0 0];
0088             writeopts.cleanup = [0];
0089             spm_preproc_write(sn,writeopts);
0090 
0091             subj.matname = fullfile(structdir,[spm_str_manip(mstruc.P(1).name,<span class="string">'sd'</span>) <span class="string">'_seg_sn.mat'</span>]);
0092             subj.invmatname = fullfile(structdir,[spm_str_manip(mstruc.P(1).name,<span class="string">'sd'</span>) <span class="string">'_seg_inv_sn.mat'</span>]);
0093             <a href="#_sub1" class="code" title="subfunction savefields(fnam,p)">savefields</a>(subj.matname,sn);
0094             <a href="#_sub1" class="code" title="subfunction savefields(fnam,p)">savefields</a>(subj.invmatname,isn);
0095  
0096         <span class="keyword">else</span>
0097           <span class="comment">% Make the default normalization parameters file name</span>
0098           <span class="comment">% Turn off template weighting</span>
0099           <span class="comment">% SPM defaults</span>
0100             subj.matname = fullfile(structdir,[spm_str_manip(subj.P(1).name,<span class="string">'sd'</span>) <span class="string">'_sn.mat'</span>]);
0101             spm_normalise(temp_imgs, fullfile(structdir,subj.P(1).name), subj.matname,<span class="keyword">...</span>
0102                 defs.estimate.weight, subj.objmask, <span class="keyword">...</span>
0103                 defs.estimate);
0104             spm_write_sn(fullfile(structdir,subj.PP(1).name),subj.matname,defs.write);
0105 
0106         <span class="keyword">end</span>;                
0107         
0108         defs.normalise.write.vox=aap.spmanalysis.structuralwritevox;
0109         spm_write_sn(fullfile(structdir,subj.PP(1).name),subj.matname,defs.write);
0110 
0111         
0112         <span class="comment">% Now save graphical check</span>
0113         figure(spm_figure(<span class="string">'FindWin'</span>));        
0114         <span class="comment">% added graphical check for when segment is used [djm 20/01/06]</span>
0115         <span class="keyword">if</span> (aap.spmanalysis.usesegmentnotnormalise)
0116             myvols=spm_vol(char(aap.directory_conventions.T1template, <span class="keyword">...</span><span class="comment"> % template T1</span>
0117                 fullfile(structdir,subj.P(1).name), <span class="keyword">...</span><span class="comment"> % native T1</span>
0118                 fullfile(structdir,strcat(<span class="string">'w'</span>,subj.P(1).name)), <span class="keyword">...</span><span class="comment"> % normalised T1</span>
0119                 fullfile(structdir,strcat(<span class="string">'c1m'</span>,subj.P(1).name)))); <span class="comment">% native grey matter segmentation</span>
0120             spm_check_registration(myvols)
0121             
0122             ann1=annotation(<span class="string">'textbox'</span>,[.05 .96 .9 .03],<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>,<span class="string">'Color'</span>,<span class="string">'r'</span>,<span class="string">'String'</span>,strcat(<span class="string">'Subject:...'</span>,subj.P(1).name,<span class="string">',  processed on:...'</span>,date));
0123             ann2=annotation(<span class="string">'textbox'</span>,[.1 .891 .3 .025],<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>,<span class="string">'Color'</span>,<span class="string">'r'</span>,<span class="string">'String'</span>,<span class="string">'T1 template'</span>);
0124             ann3=annotation(<span class="string">'textbox'</span>,[.6 .891 .3 .025],<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>,<span class="string">'Color'</span>,<span class="string">'r'</span>,<span class="string">'String'</span>,<span class="string">'Native T1'</span>);
0125             ann4=annotation(<span class="string">'textbox'</span>,[.1 .413 .3 .025],<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>,<span class="string">'Color'</span>,<span class="string">'r'</span>,<span class="string">'String'</span>,<span class="string">'Normalised T1'</span>);
0126             ann5=annotation(<span class="string">'textbox'</span>,[.6 .413 .3 .025],<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>,<span class="string">'Color'</span>,<span class="string">'r'</span>,<span class="string">'String'</span>,<span class="string">'Native segmented grey matter'</span>);
0127             print(<span class="string">'-djpeg'</span>,fullfile(subj_dir,<span class="string">'diagnostic_aamod_norm_noss'</span>));
0128         <span class="keyword">end</span>;
0129         print(<span class="string">'-djpeg'</span>,fullfile(subj_dir,<span class="string">'diagnostic_aamod_norm_noss'</span>));
0130         <span class="keyword">if</span> (aap.spmanalysis.usesegmentnotnormalise)
0131             delete(ann1); delete(ann2); delete(ann3);delete(ann4);delete(ann5);
0132         <span class="keyword">end</span>;
0133         
0134 <span class="keyword">end</span>;
0135 
0136 <span class="comment">%------------------------------------------------------------------------</span>
0137 <a name="_sub1" href="#_subfunctions" class="code">function savefields(fnam,p)</a>
0138 <span class="keyword">if</span> length(p)&gt;1, error(<span class="string">'Can''t save fields.'</span>); <span class="keyword">end</span>;
0139 fn = fieldnames(p);
0140 <span class="keyword">if</span> numel(fn)==0, <span class="keyword">return</span>; <span class="keyword">end</span>;
0141 <span class="keyword">for</span> i=1:length(fn),
0142     eval([fn{i} <span class="string">'= p.'</span> fn{i} <span class="string">';'</span>]);
0143 <span class="keyword">end</span>;
0144 <span class="keyword">if</span> str2double(version(<span class="string">'-release'</span>))&gt;=14,
0145     save(fnam,<span class="string">'-V6'</span>,fn{:});
0146 <span class="keyword">else</span>
0147     save(fnam,fn{:});
0148 <span class="keyword">end</span>;
0149 
0150 <span class="keyword">return</span>;
0151 <span class="comment">%------------------------------------------------------------------------</span>
0152 
0153 
0154 
0155 
0156 
0157 
0158 
0159 
0160 
0161</pre></div>
<hr><address>Generated on Fri 31-Aug-2007 16:39:50 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>